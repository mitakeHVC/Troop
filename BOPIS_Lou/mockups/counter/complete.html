<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>受渡完了 - BOPISカウンター</title>
  <link rel="stylesheet" href="../styles.css">
</head>
<body>
  <div class="header">
    <h1>BOPIS - 受付カウンター</h1>
    <div class="flex items-center">
        <span id="counter-name-disp" class="mr-3">カウンター様</span>|<span id="counter-tenant-disp" class="ml-3 mr-4 text-sm badge badge-info">テナント</span>
        <a href="#" id="counter-logout-button-complete" class="btn btn-sm btn-danger">ログアウト</a>
    </div>
  </div>

  <div class="container text-center py-12">
    <div class="card shadow-xl p-8" style="max-width: 500px; margin: auto;">
        <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" fill="var(--success-color)" class="bi bi-patch-check-fill mx-auto mb-5" viewBox="0 0 16 16">
            <path d="M10.067.87a2.89 2.89 0 0 0-4.134 0l-.622.638-.89-.011a2.89 2.89 0 0 0-2.924 2.924l.01.89-.636.622a2.89 2.89 0 0 0 0 4.134l.637.622-.011.89a2.89 2.89 0 0 0 2.924 2.924l.89.01-.622.636a2.89 2.89 0 0 0 4.134 0l.622-.637.89.011a2.89 2.89 0 0 0 2.924-2.924l-.01-.89.636-.622a2.89 2.89 0 0 0 0-4.134l-.637-.622.011-.89a2.89 2.89 0 0 0-2.924-2.924l-.89-.01.622-.636zm.287 5.984-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7 8.793l2.646-2.647a.5.5 0 0 1 .708.708z"/>
        </svg>
        <h2 class="text-3xl font-semibold mb-3">受渡完了</h2>
        <p id="completion-message" class="text-lg text-gray-700 mb-6">注文の処理が正常に完了しました。</p>
        <a href="dashboard.html" class="btn btn-primary btn-lg">ダッシュボードへ戻る</a>
    </div>
  </div>
  
  <div class="footer">
    <p>&copy; 2025 BOPIS System</p>
  </div>
  <script type="module">
    import { getAccessToken, logout } from '../../frontend/js/auth.js';
    import { decodeJWT, apiRequest } from '../../frontend/js/utils.js'; // apiRequest for user/tenant info

    document.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('orderId');
        const msgEl = document.getElementById('completion-message');
        if (orderId && msgEl) {
            msgEl.textContent = `注文ID: ${orderId} の受渡処理が正常に完了しました。`;
        }

        const logoutButton = document.getElementById('counter-logout-button-complete');
        if(logoutButton) {
            logoutButton.addEventListener('click', (e) => {
                e.preventDefault();
                logout('login.html');
            });
        }
        // Display user and tenant name in header
        const token = getAccessToken();
        const payload = decodeJWT(token);
        const counterNameDispEl = document.getElementById('counter-name-disp');
        const counterTenantDispEl = document.getElementById('counter-tenant-disp');

        if (counterNameDispEl && payload && payload.sub) {
            try { // Using apiRequest from utils.js, which itself imports from api.js
                const userInfo = await apiRequest('/users/me', 'GET', null, true);
                counterNameDispEl.textContent = userInfo.username || 'カウンター様';
            } catch (e) { console.warn("Failed to fetch counter user info for complete page:", e); }
        }
        if (counterTenantDispEl && payload && payload.tenant_id) {
             try {
                const tenantInfo = await apiRequest(`/tenants/${payload.tenant_id}`, 'GET', null, true);
                counterTenantDispEl.textContent = tenantInfo.name || `テナントID: ${payload.tenant_id}`;
            } catch (e) { console.warn("Failed to fetch tenant name for complete page:", e); counterTenantDispEl.textContent = `テナントID: ${payload.tenant_id}`;}
        } else if(counterTenantDispEl) {
            counterTenantDispEl.textContent = "テナント情報なし";
        }
    });
  </script>
</body>
</html>